function mxUpload(){var r=this;function s(e,a,t,i){return i=i||0,localStorage[e]=a+"|"+t+"|"+i,{fileId:a,token:t,currentPackage:i}}function f(e){if(r.fileDetails=e,r.fileDetails.currentPackage<r.totalPackages)i=function(e){var a,t=e*r.packetSize,i=t+r.packetSize;a="mozSlice"in r.file?r.file.mozSlice(t,i):"webkitSlice"in r.file?r.file.webkitSlice(t,i):r.file.slice(t,i);return a}(r.fileDetails.currentPackage),l=new XMLHttpRequest,n=r.url+"?fileid="+r.fileDetails.fileId+"&token="+r.fileDetails.token+"&packet="+r.fileDetails.currentPackage+"&fileName="+r.sfileName,c(o=r.fileDetails,0),l.open("POST",n,!0),l.onprogress=function(e){c(o,e.position)},l.onload=function(e){var a,t=JSON.parse(l.responseText);"new_packet"==t.action&&"success"==t.result&&((a=o).currentPackage++,f(s(r.fileId,a.fileId,a.token,a.currentPackage)))},l.send(i);else{var a=new FormData;a.append("fileid",r.fileDetails.fileId),a.append("token",r.fileDetails.token),a.append("fileName",r.sfileName);var t=new XMLHttpRequest;t.open("POST",r.url,!0),t.onload=function(e){if("complete"==JSON.parse(t.responseText).action){var a=Math.round((new Date).getTime()/1e3);s(r.fileId,r.fileDetails.fileId,r.fileDetails.token,"alldone|"+a),$("#mxprogress").hide(250),$("input[name='filename']").attr("value",r.sfileName),$("input[name='mask']").attr("value",r.fileName),document.getElementById("desc").value=r.fileName.substr(0,r.fileName.lastIndexOf("."))}},t.send(a)}var i,l,n,o}function c(e,a){var t=(e.currentPackage*r.packetSize+a)/r.totalSize*100;$("#progressbar").progressbar({value:t})}r.file=document.getElementById("filepicker").files[0],r.totalSize=r.file.size,r.url="model/catalog/mxupload.php",r.type=r.file.type,r.fileName=r.file.name,r.sfileName=r.fileName+"_"+Math.floor(1e6*Math.random()+1),r.packetSize=524288,r.fileId=r.sfileName+"|"+r.type+"|"+r.totalSize,r.totalPackages=Math.ceil(r.totalSize/r.packetSize),$("#mxprogress").show(250),$("#progressbar").progressbar({value:.01}),r.fileDetails=function(t){var e=localStorage[t];if(e){var a=e.split("|");f({fileId:a[0],token:a[1],currentPackage:a[2]})}else{var i=new FormData;i.append("totalSize",r.totalSize),i.append("type",r.type),i.append("fileName",r.sfileName);var l=new XMLHttpRequest;l.open("POST",r.url,!0),l.onload=function(e){var a=JSON.parse(l.responseText);"new_upload"==a.action&&f(s(t,a.fileid,a.token))},l.send(i)}}(r.fileId)}